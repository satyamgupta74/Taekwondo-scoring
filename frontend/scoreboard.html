<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Taekwondo Scoreboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="./styles.css">
</head>
<body class="p-3">
  <div class="container">
    <h1 class="mb-3 text-center">Taekwondo Scoreboard</h1>

    <div class="row g-3 mb-3">
      <div class="col-12 col-md-4">
        <button id="createBtn" class="btn btn-primary w-100">Create Match</button>
      </div>
      <div class="col-12 col-md-8 d-flex align-items-center" id="matchInfo" style="display:none;">
        <div class="me-3"><strong>Match ID:</strong> <span id="midText"></span></div>
        <div class="me-3"><strong>Share:</strong> <a href="#" id="shareLink" target="_blank">referee link</a></div>
        <button class="btn btn-outline-secondary btn-sm" id="copyLinkBtn">Copy Link</button>
      </div>
    </div>

    <div class="row mb-3" id="qrRow" style="display:none;">
      <div class="col-12 col-md-6">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <h5>Scan to Join as Referee</h5>
            <div id="qrcode" class="d-inline-block"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="board" style="display: none;">
      <div class="row text-center mb-3">
        <div class="col">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2>Round: <span id="round">1</span></h2>
              <h3>Timer: <span id="timer">60</span> sec</h3>
              <div class="d-flex justify-content-center gap-2 mt-2">
                <button class="btn btn-warning" onclick="adjustTimer(-5)">-5 sec</button>
                <button class="btn btn-warning" onclick="adjustTimer(5)">+5 sec</button>
                <button class="btn btn-danger" onclick="endRound()">End Round</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 text-center mb-3">
        <div class="col-12 col-md-6">
          <div class="card shadow-sm score-card chong">
            <div class="card-body">
              <h2>Chong</h2>
              <div class="display-4" id="chongScore">0</div>
              <div class="mt-2 small">
                <strong>Votes:</strong>
                <span class="badge bg-light text-dark">1: <span id="c1">0</span></span>
                <span class="badge bg-light text-dark">2: <span id="c2">0</span></span>
                <span class="badge bg-light text-dark">3: <span id="c3">0</span></span>
                <span class="badge bg-light text-dark">4: <span id="c4">0</span></span>
                <span class="badge bg-light text-dark">5: <span id="c5">0</span></span>
                <span class="badge bg-light text-dark">-1: <span id="c_1">0</span></span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="card shadow-sm score-card hong">
            <div class="card-body">
              <h2>Hong</h2>
              <div class="display-4" id="hongScore">0</div>
              <div class="mt-2 small">
                <strong>Votes:</strong>
                <span class="badge bg-light text-dark">1: <span id="h1">0</span></span>
                <span class="badge bg-light text-dark">2: <span id="h2">0</span></span>
                <span class="badge bg-light text-dark">3: <span id="h3">0</span></span>
                <span class="badge bg-light text-dark">4: <span id="h4">0</span></span>
                <span class="badge bg-light text-dark">5: <span id="h5">0</span></span>
                <span class="badge bg-light text-dark">-1: <span id="h_1">0</span></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 text-center">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <h4>Round Wins</h4>
              <p>Chong: <span id="rwChong">0</span> | Hong: <span id="rwHong">0</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    let matchId;
    let timerValue = 60;

    function randomCode() {
      return "TK-" + Math.random().toString(36).slice(2,6).toUpperCase() + "-" + Date.now().toString(36).slice(-4).toUpperCase();
    }

    function createMatch() {
      matchId = randomCode();
      socket.emit("joinMatch", matchId, "scoreboard");
      document.getElementById("board").style.display = "block";

      const origin = window.location.origin || "http://localhost:3000";
      const link = `${origin}/referee.html?mid=${encodeURIComponent(matchId)}`;

      document.getElementById("matchInfo").style.display = "flex";
      document.getElementById("midText").innerText = matchId;
      const a = document.getElementById("shareLink");
      a.href = link; a.textContent = link;

      document.getElementById("qrRow").style.display = "block";
      const qrel = document.getElementById("qrcode");
      qrel.innerHTML = "";
      new QRCode(qrel, { text: link, width: 180, height: 180 });

      document.getElementById("createBtn").disabled = true;
    }

    document.getElementById("createBtn").addEventListener("click", createMatch);
    document.getElementById("copyLinkBtn").addEventListener("click", async () => {
      const href = document.getElementById("shareLink").href;
      try { await navigator.clipboard.writeText(href); alert("Link copied!"); } catch {}
    });

    socket.on("updateScore", ({ scores, roundWins, currentRound, scoreCounts }) => {
      document.getElementById("chongScore").innerText = scores.chong;
      document.getElementById("hongScore").innerText = scores.hong;
      document.getElementById("round").innerText = currentRound;
      document.getElementById("rwChong").innerText = roundWins.chong;
      document.getElementById("rwHong").innerText = roundWins.hong;

      document.getElementById("c1").innerText = scoreCounts.chong["1"];
      document.getElementById("c2").innerText = scoreCounts.chong["2"];
      document.getElementById("c3").innerText = scoreCounts.chong["3"];
      document.getElementById("c4").innerText = scoreCounts.chong["4"];
      document.getElementById("c5").innerText = scoreCounts.chong["5"];
      document.getElementById("c_1").innerText = scoreCounts.chong["-1"];

      document.getElementById("h1").innerText = scoreCounts.hong["1"];
      document.getElementById("h2").innerText = scoreCounts.hong["2"];
      document.getElementById("h3").innerText = scoreCounts.hong["3"];
      document.getElementById("h4").innerText = scoreCounts.hong["4"];
      document.getElementById("h5").innerText = scoreCounts.hong["5"];
      document.getElementById("h_1").innerText = scoreCounts.hong["-1"];
    });

    function adjustTimer(change) {
      timerValue += change;
      if (timerValue < 0) timerValue = 0;
      socket.emit("updateTimer", { matchId, time: timerValue });
    }

    socket.on("timerUpdate", (time) => {
      document.getElementById("timer").innerText = time;
      timerValue = time;
    });

    function endRound() {
      socket.emit("endRound", matchId);
      timerValue = 60;
      document.getElementById("timer").innerText = timerValue;
    }
  </script>
</body>
</html>
